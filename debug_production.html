<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿäº§ç¯å¢ƒè°ƒè¯• - å›¾æ ‡åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .icon-test {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .icon-test img {
            width: 32px;
            height: 32px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç”Ÿäº§ç¯å¢ƒå›¾æ ‡åŠ è½½è°ƒè¯•</h1>
        
        <div class="debug-info">
            <h3>ç¯å¢ƒä¿¡æ¯</h3>
            <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
            <p><strong>Tauri ç¯å¢ƒ:</strong> <span id="tauriEnv"></span></p>
            <p><strong>å¼€å‘æ¨¡å¼:</strong> <span id="devMode"></span></p>
            <p><strong>Window å¯¹è±¡:</strong> <span id="windowInfo"></span></p>
        </div>

        <div class="debug-info">
            <h3>å›¾æ ‡åŠ è½½æµ‹è¯•</h3>
            <div id="iconTests"></div>
        </div>

        <div class="debug-info">
            <h3>æ§åˆ¶å°è¾“å‡º</h3>
            <div class="console-output" id="consoleOutput"></div>
        </div>
    </div>

    <script>
        // æ•è·æ§åˆ¶å°è¾“å‡º
        const consoleOutput = document.getElementById('consoleOutput');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const div = document.createElement('div');
            div.innerHTML = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('log', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('error', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('warn', ...args);
        };

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('tauriEnv').textContent = typeof window !== 'undefined' && (window.__TAURI__ || window.__TAURI_INTERNALS__) ? 'æ˜¯' : 'å¦';
        document.getElementById('devMode').textContent = 'N/A (é™æ€é¡µé¢)';
        document.getElementById('windowInfo').textContent = `__TAURI__: ${!!window.__TAURI__}, __TAURI_INTERNALS__: ${!!window.__TAURI_INTERNALS__}`;

        // æ¨¡æ‹Ÿå›¾æ ‡è·¯å¾„è§£æå‡½æ•°
        async function getPlatformIconUrl(icon) {
            console.log('ğŸ” [DEBUG] getPlatformIconUrl called with icon:', icon);
            
            // å¦‚æœæ˜¯ç½‘ç»œURLï¼Œç›´æ¥è¿”å›
            if (icon.startsWith('http://') || icon.startsWith('https://')) {
                console.log('âœ… [DEBUG] Using network URL:', icon);
                return icon;
            }
            
            // å¦‚æœæ˜¯æ–‡ä»¶åï¼Œæ„å»ºæœ¬åœ°è·¯å¾„
            if (icon.includes('.')) {
                try {
                    // ä½¿ç”¨æ›´å¯é çš„ç¯å¢ƒæ£€æµ‹
                    const isTauriEnv = typeof window !== 'undefined' && (window.__TAURI__ || window.__TAURI_INTERNALS__);
                    console.log('ğŸ” [DEBUG] Environment detection - isTauriEnv:', isTauriEnv);
                    console.log('ğŸ” [DEBUG] window.__TAURI__:', typeof window !== 'undefined' ? !!window.__TAURI__ : 'undefined');
                    console.log('ğŸ” [DEBUG] window.__TAURI_INTERNALS__:', typeof window !== 'undefined' ? !!window.__TAURI_INTERNALS__ : 'undefined');
                    
                    if (isTauriEnv) {
                        console.log('ğŸš€ [DEBUG] Tauri environment detected, attempting resource resolution');
                        
                        try {
                            // æ–¹æ³•1ï¼šä½¿ç”¨ resolveResource API
                            console.log('ğŸ” [DEBUG] Attempting method 1: resolveResource API');
                            
                            // æ£€æŸ¥ Tauri API æ˜¯å¦å¯ç”¨
                            if (window.__TAURI_INTERNALS__) {
                                console.log('ğŸ” [DEBUG] __TAURI_INTERNALS__ available:', Object.keys(window.__TAURI_INTERNALS__));
                            }
                            
                            // å°è¯•åŠ¨æ€å¯¼å…¥ Tauri API
                            const pathModule = await import('@tauri-apps/api/path');
                            const coreModule = await import('@tauri-apps/api/core');
                            
                            console.log('ğŸ” [DEBUG] Tauri modules loaded successfully');
                            
                            const resourcePath = await pathModule.resolveResource(`src/assets/images/providers/${icon}`);
                            console.log('âœ… [DEBUG] Method 1 - Resolved resource path:', resourcePath);
                            const convertedUrl = coreModule.convertFileSrc(resourcePath);
                            console.log('âœ… [DEBUG] Method 1 - Converted URL:', convertedUrl);
                            return convertedUrl;
                        } catch (resolveError) {
                            console.error('âŒ [DEBUG] Method 1 failed - resolveResource error:', resolveError);
                            console.error('âŒ [DEBUG] Error details:', {
                                name: resolveError.name,
                                message: resolveError.message,
                                stack: resolveError.stack
                            });
                            
                            // æ–¹æ³•2ï¼šå°è¯•ç›´æ¥ä½¿ç”¨ convertFileSrc ä¸ç›¸å¯¹è·¯å¾„
                            try {
                                console.log('ğŸ” [DEBUG] Attempting method 2: direct convertFileSrc');
                                const coreModule = await import('@tauri-apps/api/core');
                                const directPath = `src/assets/images/providers/${icon}`;
                                console.log('ğŸ” [DEBUG] Method 2 - Direct path:', directPath);
                                const convertedUrl = coreModule.convertFileSrc(directPath);
                                console.log('âœ… [DEBUG] Method 2 - Converted URL:', convertedUrl);
                                return convertedUrl;
                            } catch (convertError) {
                                console.error('âŒ [DEBUG] Method 2 failed - convertFileSrc error:', convertError);
                                console.error('âŒ [DEBUG] Error details:', {
                                    name: convertError.name,
                                    message: convertError.message,
                                    stack: convertError.stack
                                });
                                
                                // æ–¹æ³•3ï¼šå›é€€åˆ°ç›¸å¯¹è·¯å¾„
                                const fallbackPath = `/src/assets/images/providers/${icon}`;
                                console.log('âš ï¸ [DEBUG] Method 3 - Using fallback path:', fallbackPath);
                                return fallbackPath;
                            }
                        }
                    } else {
                        // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                        const browserPath = `/src/assets/images/providers/${icon}`;
                        console.log('ğŸŒ [DEBUG] Using browser path:', browserPath);
                        return browserPath;
                    }
                } catch (error) {
                    console.error('ğŸ’¥ [DEBUG] Critical error in getPlatformIconUrl:', error);
                    console.error('ğŸ’¥ [DEBUG] Error details:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    // å›é€€åˆ°å¼€å‘ç¯å¢ƒè·¯å¾„
                    const emergencyPath = `/src/assets/images/providers/${icon}`;
                    console.log('ğŸ†˜ [DEBUG] Using emergency fallback path:', emergencyPath);
                    return emergencyPath;
                }
            }
            
            // å¦‚æœæ˜¯emojiæˆ–å…¶ä»–å­—ç¬¦ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²è®©å…¶ä½¿ç”¨æ–‡å­—å›é€€
            console.log('ğŸ“ [DEBUG] Icon is not a file, returning empty string for:', icon);
            return '';
        }

        // æµ‹è¯•å›¾æ ‡åˆ—è¡¨
        const testIcons = [
            'openai.png',
            'anthropic.png',
            'google.png',
            'gemini.png',
            'deepseek.png',
            'moonshot.png',
            'zhipu.png',
            'baidu-cloud.svg',
            'ollama.png',
            'groq.png',
            'perplexity.png',
            'mistral.png'
        ];

        // æ‰§è¡Œå›¾æ ‡æµ‹è¯•
        async function runIconTests() {
            const iconTestsContainer = document.getElementById('iconTests');
            
            for (const icon of testIcons) {
                console.log(`\n=== å¼€å§‹æµ‹è¯•å›¾æ ‡: ${icon} ===`);
                
                const testDiv = document.createElement('div');
                testDiv.className = 'icon-test';
                
                try {
                    const iconUrl = await getPlatformIconUrl(icon);
                    console.log(`âœ… å›¾æ ‡ ${icon} è§£ææˆåŠŸ: ${iconUrl}`);
                    
                    const img = document.createElement('img');
                    img.src = iconUrl;
                    img.alt = icon;
                    
                    img.onload = () => {
                        console.log(`âœ… å›¾æ ‡ ${icon} åŠ è½½æˆåŠŸ`);
                        testDiv.innerHTML = `<img src="${iconUrl}" alt="${icon}"> <span class="success">${icon} - åŠ è½½æˆåŠŸ</span>`;
                    };
                    
                    img.onerror = () => {
                        console.error(`âŒ å›¾æ ‡ ${icon} åŠ è½½å¤±è´¥: ${iconUrl}`);
                        testDiv.innerHTML = `<span class="error">âŒ ${icon} - åŠ è½½å¤±è´¥ (${iconUrl})</span>`;
                    };
                    
                    testDiv.appendChild(img);
                    testDiv.innerHTML += `<span>${icon} - è§£æä¸­...</span>`;
                    
                } catch (error) {
                    console.error(`âŒ å›¾æ ‡ ${icon} è§£æå¤±è´¥:`, error);
                    testDiv.innerHTML = `<span class="error">âŒ ${icon} - è§£æå¤±è´¥: ${error.message}</span>`;
                }
                
                iconTestsContainer.appendChild(testDiv);
                console.log(`=== å®Œæˆæµ‹è¯•å›¾æ ‡: ${icon} ===\n`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒå›¾æ ‡åŠ è½½è°ƒè¯•æµ‹è¯•');
            runIconTests();
        });
    </script>
</body>
</html>